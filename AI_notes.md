# Заметки AI по проекту PyRobot

---

## Общая информация по проекту

* **Запуск тестов:**
  * Все тесты: `pytest -v`
  * Конкретный тест: `pytest -v tests/test_functional.py -k "имя_файла.kum"`
  * Все файлы kum: `tests/polyakov_kum`
* **Документация по языку Кумир:** `kumir2-master/userdocs/`
* **Исходный код оригинального Кумира (C++):** `kumir2-master/src`
* **Наиболее важные исходники:** `kumir2-master/src/kumir2-libs`, `kumir2-master/src/plugins`

---

## Заметки по доработке интерпретатора КуМира

Задачи, которые нужно реализовать для прохождения тестов:

1. **Встроенные функции `irand` и `rand`:**
    * Проблема: Интерпретатор не распознает `irand` и `rand` как встроенные функции, считает их необъявленными переменными.
    * Файл теста: `tests/polyakov_kum/7-rand.kum`
    * Место в коде: Вероятно, `visitPostfixExpression` или `visitPrimaryExpression` в `pyrobot/backend/kumir_interpreter/interpreter.py`.

2. **Цикл `нц N раз`:**
    * Проблема: Интерпретатор вызывает `NotImplementedError`, так как этот тип цикла еще не реализован.
    * Файл теста: `tests/polyakov_kum/8-if.kum`
    * Место в коде: Ветка `elif loop_spec.expression():` в методе `visitLoopStatement` в `pyrobot/backend/kumir_interpreter/interpreter.py`.

3. **Оператор `выбор` (switch):**
    * Проблема: `KumirEvalError: ... Ошибка вычисления условия: 'NoneType' object has no attribute 'start'`. Интерпретатор не может получить значение для сравнения.
    * Файлы тестов: `11-switch.kum`, `12-switch.kum`.
    * Место в коде: `visitSwitchStatement` в `interpreter.py` (требует также исправления грамматики `KumirParser.g4`).

4. **Обработка переменных цикла:**
    * Проблема: `KumirEvalError: ... name 'X' is not defined` или похожие ошибки в циклах `нц N раз`, `пока`, `для`.
    * Файлы тестов: `13-loopN.kum`, `14-while.kum`, `17-for.kum`.
    * Место в коде: `visitLoopStatement` в `interpreter.py`.

5. **Цикл `до` (repeat...until):** (**РЕШЕНО**)
    * Файл теста: `16-repeat.kum`.
    * Место в коде: `visitLoopStatement` в `interpreter.py`.

6. **Проблема с чтением ввода (`\\n`):**
    * Проблема: `KumirEvalError: ... Ошибка преобразования типа ... invalid literal for int() with base 10: 'X\\n'`. `input()` считывает символ переноса строки вместе со значением.
    * Файл теста: `20-proc-err.kum` (и, возможно, другие).
    * Место в коде: Строка `value_str = input()` и последующая конвертация в `visitIoStatement` в `interpreter.py`. Нужно убирать `\\n` перед `int()`.

7. **Несоответствие вывода (AssertionError):**
    * Проблема: Фактический вывод не совпадает с ожидаемым (часто из-за промптов или логики вывода).
    * Файлы тестов: `10-and.kum`, `15-while.kum`, `18-downto.kum`, `19-prime.kum`.
    * Решение: Нужно сравнить вывод с оригинальным КуМиром и скорректировать либо ожидаемый вывод в `TEST_CASES` (добавив промпты, если они есть в программе), либо логику вывода в интерпретаторе.

8. **Ошибка парсинга файла:**
    * Проблема: Парсер ANTLR не может обработать файл, считает весь код одной строкой (`no viable alternative at input 'алгКоличествоцифрнач...'`). Проблема не в `\\r\\n` и не в кодировке (UTF-8).
    * Файл теста: `15-while.kum`.
    * Возможная причина: Проблема в грамматике `.g4` или сгенерированном лексере/парсере, который некорректно обрабатывает какую-то конструкцию или последовательность символов в этом файле.
    * Решение: Требует глубокого анализа грамматики и, возможно, перегенерации парсера.