# Заметки AI по проекту PyRobot

---

## Общая информация по проекту

* **Запуск тестов:**
  * Все тесты: `pytest -v`
  * Конкретный тест: `pytest -v tests/test_functional.py -k "имя_файла.kum"`
  * Все файлы kum: `tests/polyakov_kum`
* **Документация по языку Кумир:** `kumir2-master/userdocs/`
* **Исходный код оригинального Кумира (C++):** `kumir2-master/src`
* **Наиболее важные исходники:** `kumir2-master/src/kumir2-libs`, `kumir2-master/src/plugins`

---

## Заметки по доработке интерпретатора КуМира

Задачи, которые нужно реализовать для прохождения тестов:

1. **Встроенные функции `irand` и `rand` (а также необъявленные идентификаторы типа `printBin`):**
    * Проблема: Интерпретатор не распознает `irand`, `rand`, `printBin` и т.п. как встроенные функции/процедуры или переменные, считает их необъявленными.
    * Файл теста: `tests/polyakov_kum/7-rand.kum` (и другие, вызвавшие ошибку `printBin`).
    * Место в коде: Вероятно, `visitPostfixExpression`, `visitPrimaryExpression`, `visitProcedureCallStatement` в `pyrobot/backend/kumir_interpreter/interpreter.py`. Обработка вызовов и поиск имен.

2. **Цикл `нц N раз`:**
    * Проблема: Интерпретатор вызывает `NotImplementedError`, так как этот тип цикла еще не реализован.
    * Файл теста: `tests/polyakov_kum/8-if.kum`
    * Место в коде: Ветка `elif loop_spec.expression():` в методе `visitLoopStatement` в `pyrobot/backend/kumir_interpreter/interpreter.py`.

3. **Оператор `выбор` (switch):**
    * Проблема: `KumirEvalError: ... Ошибка вычисления условия: 'NoneType' object has no attribute 'start'` (Изначально). Сейчас падает из-за **несовместимости типов при сравнении `<` (float и int)** (см. тест `12-switch.kum`) **или из-за отсутствия реальной логики switch** (заглушка `switch_value = None`) (см. тест `11-switch.kum`).
    * Файлы тестов: `11-switch.kum`, `12-switch.kum`.
    * Место в коде: `visitSwitchStatement` (требует исправления грамматики `KumirParser.g4`) и `_perform_binary_operation` (сравнение типов **ИСПРАВЛЕНО**, но сам switch не работает).

4. **Обработка переменных цикла:**
    * Проблема: `KumirEvalError: ... name 'X' is not defined` или похожие ошибки. **Частично решено:** Реализована локальная область видимости для `ДЛЯ`. Ошибки могут оставаться внутри тел циклов или для других типов циклов.
    * Файлы тестов: `13-loopN.kum`, `14-while.kum`, `17-for.kum` (и другие циклы).
    * Место в коде: `visitLoopStatement` в `interpreter.py`.

5. **Цикл `до` (repeat...until):** (**РЕШЕНО**)
    * Проблема: Цикл не был реализован.
    * Файл теста: `16-repeat.kum`.
    * Место в коде: `visitLoopStatement` в `interpreter.py`. (Логика добавлена).

6. **Проблема с чтением ввода (`\n`):** (**РЕШЕНО**)
    * Проблема: `KumirEvalError: ... invalid literal for int() with base 10: 'X\n'`. `input()` считывал `\n`.
    * Файлы тестов: `11-switch.kum`, `12-switch.kum` и другие с вводом.
    * Место в коде: `visitIoStatement` в `interpreter.py`. (Добавлено удаление `\\n`).

7. **Несоответствие вывода (AssertionError):**
    * Проблема: Фактический вывод не совпадает с ожидаемым. **Частично решено:** Исправлены ожидаемые/входные данные для тестов `13`, `14`, `16`, `17`, `18`, `19`. Добавлен `rstrip()` в test runner.
    * Файлы тестов: Некоторые тесты все еще могут падать из-за этого (`15-while.kum` - но там основная проблема в парсинге).
    * Решение: Нужно сравнить вывод с оригинальным КуМиром и скорректировать либо ожидаемый вывод в `TEST_CASES`, либо логику вывода в интерпретаторе.

8. **Ошибка парсинга файла `15-while.kum`:** (**АКТУАЛЬНО**)
    * Проблема: Парсер ANTLR не может обработать файл (`no viable alternative at input 'алгКоличествоцифрнач...'`).
    * Файл теста: `15-while.kum`.
    * Возможная причина: Проблема в грамматике `.g4` или сгенерированном лексере/парсере.
    * Решение: Требует глубокого анализа грамматики и, возможно, перегенерации парсера.

# Заметки по разработке

## 2024-03-21
1. Исправлена обработка встроенных процедур в методе `visitPostfixExpression`:
   - Добавлена проверка на встроенные процедуры перед проверкой пользовательских
   - Добавлена обработка количества аргументов для встроенных процедур
   - Исправлен вызов встроенных процедур с правильной передачей аргументов

2. Исправлена обработка условного оператора в методе `visitIfStatement`:
   - Добавлено извлечение значения из переменной для условия
   - Улучшена обработка ветвей "то" и "иначе"

3. Добавлена встроенная процедура `printBin`:
   - Реализована функция для вывода числа в двоичном виде
   - Добавлена поддержка форматирования с фиксированной шириной

TODO:
1. Исправить форматирование вывода в тесте `format.kum`
2. Исправить обработку оператора выбора в `switch.kum`
3. Исправить обработку циклов в `loopN.kum`, `while.kum`, `for.kum`, `downto.kum`
4. Исправить алгоритм поиска простых чисел в `prime.kum`