import pytest
import os
import sys
from io import StringIO
from contextlib import redirect_stdout, redirect_stderr

from pyrobot.backend.kumir_interpreter.interpreter import interpret_kumir
from pyrobot.backend.kumir_interpreter.kumir_exceptions import KumirSyntaxError, KumirEvalError

# Определяем директорию с примерами КуМир относительно текущего файла
current_dir = os.path.dirname(os.path.abspath(__file__))
# Нормализуем путь, чтобы избежать проблем с '..' - УДАЛЕНО, ТАК КАК ПУТЬ НЕПРАВИЛЬНЫЙ
# PROGRAMS_DIR = os.path.abspath(os.path.join(current_dir, "..", "polyakov_kum"))
# Исправляем путь на tests/polyakov_kum
PROGRAMS_DIR = os.path.join(current_dir, "polyakov_kum")

TEST_CASES = [
    ('1-empty.kum', None, ''),  # Пустая программа
    ('2-2+2.kum', None, '2+2=?\nОтвет: 4\n'),  # Простое сложение - ОБНОВЛЕНО ПО ОРИГИНАЛУ (с финальным \n)
    ('3-a+b.kum', '2\n3\n', '2 3\n5\n'),  # Сложение с вводом - ОБНОВЛЕНО ПО ОРИГИНАЛУ (с эхом ввода)
    ('4-a+b.kum', '10\n20\n', 'Введите два целых числа: 10 20\n10+20=30\n'),  # Сложение с вводом - ОБНОВЛЕНО ПО ОРИГИНАЛУ (с эхом ввода)
    ('6-format.kum', None, '>  123<\n1.2345678\n>  1.235<\n'),  # Форматированный вывод
    ('7-rand.kum', None, None),  # Случайные числа - проверяем только запуск
    ('8-if.kum', '5\n7\n', 'Введите два целых числа: 5 7\nМаксимальное число:\n7\n7\n7\n7\n'), # Условный оператор - ОБНОВЛЕНО ПО ОРИГИНАЛУ (с эхом ввода)
    ('9-if.kum', '-3\n5\n', 'Введите возраст Андрея и Бориса: -3 5\nБорис старше\n'), # Условный оператор, ветвление - ОБНОВЛЕНО ПО ОРИГИНАЛУ (с эхом ввода)
    ('10-and.kum', '27\n', "Введите возраст: 27\nподходит\n"),  # Логическое И - ОБНОВЛЕНО ПО ОРИГИНАЛУ (с эхом ввода)
    ('11-switch.kum', '2\n', 'Введите номер месяца: 2\nфевраль\n'), # Выбор (месяц) - ОБНОВЛЕНО ПО ОРИГИНАЛУ (с эхом ввода)
    ('12-switch.kum', '7\n', '7\n1\n'),                # Выбор (знак числа) - ОБНОВЛЕНО ПО ОРИГИНАЛУ (с эхом ввода)
    ('13-loopN.kum', '5\n', 'Сколько раз сделать? 5\nпривет\nпривет\nпривет\nпривет\nпривет\n'), # Цикл НЦ раз - ОБНОВЛЕНО ПО ОРИГИНАЛУ (с эхом ввода)
    ('14-while.kum', '5\n', 'Сколько раз сделать? 5\nпривет\nпривет\nпривет\nпривет\nпривет\n'), # Цикл ПОКА - ОБНОВЛЕНО ПО ОРИГИНАЛУ (с эхом ввода)
    ('15-while.kum', '12345\n', "Введите целое число: 12345\nЦифр в числе: 5\n"), # Цикл ПОКА (подсчет цифр) - ОБНОВЛЕНО ПО ОРИГИНАЛУ (с эхом ввода)
    ('16-repeat.kum', '-1\n0\n2\n', 'Введите целое положительное число: -1\n0\n2\nВведено число 2\n  и до него 2 ошибочных значений(я)\n'), # Цикл ДО - ОБНОВЛЕНО ПО ОРИГИНАЛУ (с эхом ввода)
    ('17-for.kum', '5\n', '5\n2 4 8 16 32 \n'),            # Цикл ДЛЯ (степени двойки) - ОБНОВЛЕНО ПО ОРИГИНАЛУ (с эхом ввода)
    ('18-downto.kum', '5\n', '5\n32 16 8 4 2 \n'),         # Цикл ДЛЯ с downto - ОБНОВЛЕНО ПО ОРИГИНАЛУ (с эхом ввода)
    ('19-prime.kum', '17\n', 'Введите максимальное число: 17\nПростые числа: 2 3 5 7 11 13 17 \n'),  # Проверка простоты числа - ОБНОВЛЕНО ПО ОРИГИНАЛУ (с эхом ввода)
    ('20-proc-err.kum', '-1\n', '-1\nОшибка программы\n'), # Вызов процедуры по условию - ОБНОВЛЕНО ПО ОРИГИНАЛУ (вход -1, с эхом)
    ('21-proc-bin.kum', '13\n', 'Введите натуральное число: 13\nДвоичный код: 00001101\n'), # Процедура перевода в двоичную - ОБНОВЛЕНО ПО ОРИГИНАЛУ (с эхом ввода)
    ('1-primes.kum', '100\n', 'Введите максимальное число: 100\nПростые числа от 2 до 100:\n2 3 5 7 11 13 17 19 23 29 31 37 41 43 47 53 59 61 67 71 73 79 83 89 97 \n'), # Решето Эратосфена - ОБНОВЛЕНО ПО ОРИГИНАЛУ (с эхом ввода)
    ('2-longnum.kum', None, 'Факториал числа 100:\n93326215443944152681699238856266700490715968264381621468592963895217599993229915608941463976156518286253697920827223758251185210916864000000000000000000000000\n'), # Длинные числа (факториал) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('22-swap.kum', '2\n3\n', 'Введите два целых числа: 2 3\nПосле обмена: x=3 y=2\n'), # Процедура с аргрез (обмен) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('23-func-sumdig.kum', '12345\n', 'Введите целое число: 12345\nСумма цифр 15\n'), # Функция (сумма цифр) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('24-func-prime.kum', '15\n', 'Введите максимальное число: 15\nПростые числа: 2 3 5 7 11 13 \n'), # Логическая функция (проверка простоты) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('25-func-prime.kum', '5\n7\n12\n', 'Введите число: 5\n5 - простое число\nВведите число: 7\n7 - простое число\nВведите число: 12\n'), # Цикл ПОКА с логической функцией - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('26-rec-hanoi.kum', None, '1 -> 3\n1 -> 2\n3 -> 2\n1 -> 3\n2 -> 1\n2 -> 3\n1 -> 3\n'), # Рекурсия (Ханойские башни) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('27-rec-bin.kum', '99\n', 'Введите натуральное число: 99\nДвоичный код 1100011\n'), # Рекурсия (двоичный код) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('28-rec-sumdig.kum', '12345\n', 'Введите натуральное число: 12345\nСумма цифр 15\n'), # Рекурсия (сумма цифр) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('29-rec-nod.kum', '14\n21\n', 'Введите два натуральных числа: 14 21\nНОД(14,21)=7\n'), # Рекурсия (НОД) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('30-rec-fact.kum', '4\n', 'Введите натуральное число: 4\n-> N=4\n-> N=3\n-> N=2\n-> N=1\n<- N=1\n<- N=2\n<- N=3\n<- N=4\n24\n'), # Рекурсия (факториал) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('31-arr-empty.kum', None, ''), # Массивы (объявление, пустой вывод) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('32-arr-kvad.kum', '9\n', 'Введите размер массива: 9\n1 4 9 16 25 36 49 64 81 \n'), # Массивы (квадраты) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('33-arr-input.kum', '4\n9\n-2\n0\n1\n', 'Введите размер массива: 4\nВведите элементы массива:\nA[1]=9\nA[2]=-2\nA[3]=0\nA[4]=1\nМассив задом наперёд: \n1 0 -2 9 \n'), # Массивы (ввод/вывод) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('34-arr-rand.kum', '8\n', None), # Массивы (случайные числа) - ДОБАВЛЕНО ПО ОРИГИНАЛУ (проверка только запуска)
    ('35-arr-sum.kum', '7\n180\n185\n100\n200\n170\n188\n190\n', 'Введите размер массива:\n7\nВведите элементы массива:\n180\n185\n100\n200\n170\n188\n190\nЭлементы 180 < x < 190:\nКоличество: 2\nСумма:      373\nСреднее:    186.5\n'), # Массивы (сумма/среднее) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('36-arr-search.kum', '6\n-3\n3\n0\n2\n12\n-45\n0\n', 'Введите размер массива: 6\nВведите элементы массива: \n-3\n3\n0\n2\n12\n-45\nЧто ищем? 0\nA[3]=0\n'), # Массивы (линейный поиск) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('37-arr-search.kum', '7\n-3\n-2\n-1\n0\n1\n2\n3\n1\n', 'Введите размер массива: 7\nВведите элементы массива: \n-3\n-2\n-1\n0\n1\n2\n3\nЧто ищем? 1\nA[5]=1\n'), # Массивы (линейный поиск с break) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('39-arr-rev.kum', '7\n-2\n-1\n0\n1\n2\n3\n4\n', 'Введите размер массива: 7\nВведите элементы массива: \n-2\n-1\n0\n1\n2\n3\n4\nПосле реверса:\n4 3 2 1 0 -1 -2 \n'), # Массивы (реверс) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('40-arr-shift.kum', '5\n-3\n-2\n0\n2\n3\n', 'Введите размер массива: 5\nВведите элементы массива: \n-3\n-2\n0\n2\n3\nПосле сдвига влево:\n-2 0 2 3 -3 \n'), # Массивы (сдвиг влево) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('42-arr-bsort.kum', '4\n-12\n0\n3\n1\n', 'Введите размер массива: 4\nВведите элементы массива:\n-12\n0\n3\n1\nПосле сортировки:\n-12 0 1 3 \n'), # Массивы (сортировка пузырьком) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('42a-arr-bsort.kum', '6\n-12\n43\n11\n0\n-3\n-5412\n', 'Введите размер массива: 6\nВведите элементы массива:\n-12\n43\n11\n0\n-3\n-5412\nПосле сортировки:\n-5412 -12 -3 0 11 43 \n'), # Массивы (улучш. сортировка пузырьком) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('43-arr-msort.kum', '5\n-1\n8\n4\n5\n-21\n', 'Введите размер массива: 5\nВведите элементы массива: \n-1\n8\n4\n5\n-21\nПосле сортировки:\n-21 -1 4 5 8 \n'), # Массивы (сортировка выбором) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('44-arr-qsort.kum', None, 'До сортировки:\n78 6 82 67 55 44 34 \nПосле сортировки:\n6 34 44 55 67 78 82 \n'), # Массивы (быстрая сортировка) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('46-str-ab.kum', 'ааабббвввгггдддееежжж\n', 'ааабббвввгггдддееежжж\nббббббвввгггдддееежжж\n'), # Строки (замена а на б) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('47-str-ops.kum', None, 'Привет, Вася!\n34567\n129\n12ABC3456789\n\n'), # Строки (операции) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('48-str-search.kum', None, 'Номер символа 4\n'), # Строки (поиск) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('49-str-complex.kum', 'Николай Ильич Щитфаков\n', 'Введите имя, отчество и фамилию:Николай Ильич Щитфаков\nЩитфаков Н. И.\n'), # Строки (ФИО) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('50-str-num.kum', None, '246\n246.912\n123\n123.456\n\n'), # Строки (преобразование в число) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('51-str-proc.kum', None, 'A12B.A12B.A12B\n'), # Строки (процедура replaceAll) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('52-str-func.kum', None, 'A12B.A12B.A12B\n'), # Строки (функция replaceAll) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('53-str-rec.kum', None, 'ЫЫЫ\nЫЫШ\nЫЫЧ\nЫЫО\nЫШЫ\nЫШШ\nЫШЧ\nЫШО\nЫЧЫ\nЫЧШ\nЫЧЧ\nЫЧО\nЫОЫ\nЫОШ\nЫОЧ\nЫОО\nШЫЫ\nШЫШ\nШЫЧ\nШЫО\nШШЫ\nШШШ\nШШЧ\nШШО\nШЧЫ\nШЧШ\nШЧЧ\nШЧО\nШОЫ\nШОШ\nШОЧ\nШОО\nЧЫЫ\nЧЫШ\nЧЫЧ\nЧЫО\nЧШЫ\nЧШШ\nЧШЧ\nЧШО\nЧЧЫ\nЧЧШ\nЧЧЧ\nЧЧО\nЧОЫ\nЧОШ\nЧОЧ\nЧОО\nОЫЫ\nОЫШ\nОЫЧ\nОЫО\nОШЫ\nОШШ\nОШЧ\nОШО\nОЧЫ\nОЧШ\nОЧЧ\nОЧО\nООЫ\nООШ\nООЧ\nООО\n\n'), # Строки (рекурсивный перебор) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('54-str-sort.kum', '5\nпароход\nпаровоз\nпар\nПар\nпАр\n', 'Введите количество строк: 5\nВведите строки: \nпароход\nпаровоз\nпар\nПар\nпАр\nПосле сортировки: \nПар\nпАр\nпар\nпаровоз\nпароход\n\n'), # Строки (сортировка) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('55-matr-declare.kum', None, ''), # Матрицы (объявление) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
    ('56-matr-rand.kum', None, None), # Матрицы (случайные числа) - ДОБАВЛЕНО ПО ОРИГИНАЛУ (проверка только запуска)
    ('57-matr-sum.kum', None, 'Матрица: \n2 3 4 5 \n3 4 5 6 \n4 5 6 7 \nСумма элементов 54\n'), # Матрицы (сумма элементов) - ДОБАВЛЕНО ПО ОРИГИНАЛУ
]

def run_kumir_program(program_path: str, input_data: str | None = None) -> str:
    """
    Запускает программу КуМир и возвращает её стандартный вывод.

    Args:
        program_path (str): Путь к файлу программы .kum
        input_data (str, optional): Строка с входными данными. Defaults to None.

    Returns:
        str: Стандартный вывод программы.
    """
    try:
        with open(program_path, 'r', encoding='utf-8') as f:
            code = f.read()
            # --- ВОЗВРАЩАЕМ НОРМАЛИЗАЦИЮ ПЕРЕНОСОВ СТРОК ---
            code = code.replace('\r\n', '\n').replace('\r', '\n')

        # --- ВОЗВРАЩАЕМ ПЕРЕХВАТ IO И ЗАМЕНУ STDIN --- 
        output_buffer = StringIO()
        input_buffer = StringIO(input_data if input_data else '')
        stderr_buffer = StringIO()
        old_stdin = sys.stdin
        try:
            with redirect_stdout(output_buffer), redirect_stderr(stderr_buffer):
                sys.stdin = input_buffer
                interpret_kumir(code)  # Запускаем интерпретатор
        except Exception as e:
            print(f"--- ОШИБКА ПРИ ВЫПОЛНЕНИИ {os.path.basename(program_path)} ---", file=sys.__stderr__)
            captured_stderr = stderr_buffer.getvalue()
            if captured_stderr:
                print("--- Перехваченный STDERR: ---", file=sys.__stderr__)
                print(captured_stderr, file=sys.__stderr__)
                print("----------------------------- ", file=sys.__stderr__)
            print("--- Исключение Python: ---", file=sys.__stderr__)
            import traceback
            traceback.print_exc(file=sys.__stderr__)
            print("------------------------- ", file=sys.__stderr__)
            raise e 
        finally:
            sys.stdin = old_stdin
        # -------------------------------------------------------------

        result = output_buffer.getvalue()
        # --- ВОЗВРАЩАЕМ ДОБАВЛЕНИЕ ПЕРЕНОСА СТРОКИ (если его нет) ---
        if result and not result.endswith('\n'):
            result += '\n'
        # -----------------------------------------------------------
        return result

    except Exception as e: 
        print(f"Неожиданная ошибка при запуске теста {program_path}: {e}", file=sys.stderr)
        import traceback
        traceback.print_exc(file=sys.stderr)
        raise


@pytest.mark.parametrize("program,input_data,expected_output", TEST_CASES)
def test_kumir_program(program, input_data, expected_output):
    """
    Тестирует выполнение программы на КуМире.
    
    Args:
        program (str): Имя файла программы
        input_data (str): Входные данные (если нужны)
        expected_output (str): Ожидаемый вывод
    """
    program_path = os.path.join(PROGRAMS_DIR, program)
    assert os.path.exists(program_path), f"Файл программы не найден: {program}"
    
    actual_output = run_kumir_program(program_path, input_data)
    if expected_output is not None:  # Пропускаем проверку для программ с недетерминированным выводом
        assert actual_output == expected_output, \
            f"Неверный вывод для {program}:\nОжидалось:\n{expected_output}\nПолучено:\n{actual_output}" 