#!/usr/bin/env python3
"""
–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –∫—É—Ä—Å–æ–≤ –ü–æ–ª—è–∫–æ–≤–∞.

–ü–∞—Ä—Å–∏—Ç .kurs.xml –∏ .work.xml —Ñ–∞–π–ª—ã, –∏–∑–≤–ª–µ–∫–∞–µ—Ç —ç—Ç–∞–ª–æ–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –∏–∑ –∞—Ç—Ä–∏–±—É—Ç–∞ 'prg'
—ç–ª–µ–º–µ–Ω—Ç–æ–≤ <USER_PRG>/<TESTED_PRG>, –∏ —Å–æ–∑–¥–∞–µ—Ç pytest-—Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä–∞ –ö—É–ú–∏—Ä.

–û—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã XML –∏–∑ kurs_test_gen_info.md.
"""

import xml.etree.ElementTree as ET
import re
import html
from pathlib import Path
from typing import Dict, List, Optional
from datetime import datetime

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
POLYAKOV_KURS_WORK_DIR = Path("c:/Users/Bormotoon/VSCodeProjects/PyRobot/polyakov_kurs_work")
GENERATED_TESTS_DIR = Path("c:/Users/Bormotoon/VSCodeProjects/PyRobot/tests/generated_course_tests")
TEST_TEMPLATE_PATH = Path("c:/Users/Bormotoon/VSCodeProjects/PyRobot/tests/test_polyakov_kum.py")

# –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
GENERATED_TESTS_DIR.mkdir(parents=True, exist_ok=True)


def sanitize_filename(name: str) -> str:
    """–û—á–∏—â–∞–µ—Ç –∏–º—è —Ñ–∞–π–ª–∞ –æ—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã."""
    # –£–¥–∞–ª—è–µ–º –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è –∏–º–µ–Ω —Ñ–∞–π–ª–æ–≤
    name = re.sub(r'[<>:"/\\|?*]', '', name)
    # –ó–∞–º–µ–Ω—è–µ–º –ø—Ä–æ–±–µ–ª—ã –Ω–∞ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è
    name = name.replace(" ", "_")
    # –£–¥–∞–ª—è–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è
    name = re.sub(r'_+', '_', name)
    # –£–±–∏—Ä–∞–µ–º –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ
    name = name.strip('_')
    return name if name else "unnamed"


def parse_kurs_xml(kurs_file_path: Path) -> Dict[str, Dict[str, str]]:
    """
    –ü–∞—Ä—Å–∏—Ç .kurs.xml —Ñ–∞–π–ª –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–¥–∞—á–∞—Ö.
    
    Returns:
        Dict[task_id, {name: str, id: str}]
    """
    tasks: Dict[str, Dict[str, str]] = {}
    
    try:
        tree = ET.parse(kurs_file_path)
        root = tree.getroot()
        
        # –ò—â–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã <T> —Å –∞—Ç—Ä–∏–±—É—Ç–æ–º id
        for task_node in root.findall(".//T[@id]"):
            task_id = task_node.get("id")
            if not task_id:
                continue
                
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∑–∞–¥–∞—á–∞ (–∏–º–µ–µ—Ç <PROGRAM>)
            program_node = task_node.find("PROGRAM")
            if program_node is None or not program_node.text or not program_node.text.strip():
                continue
                
            # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∑–∞–¥–∞—á–∏
            task_name = None
            
            # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∏–∑ xml:name
            if task_name is None:
                task_name = task_node.get("{http://www.w3.org/XML/1998/namespace}name")
            
            # –ü–æ—Ç–æ–º –∏–∑ –æ–±—ã—á–Ω–æ–≥–æ name
            if task_name is None:
                task_name = task_node.get("name")
            
            # –ï—Å–ª–∏ –∏–º—è —Å–ª–∏—à–∫–æ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ (—Ç–∏–ø–∞ "1-0"), –∏—â–µ–º –≤ –æ–ø–∏—Å–∞–Ω–∏–∏
            if task_name is None or re.fullmatch(r"\d+-\d+", task_name):
                desc_node = task_node.find("DESC")
                if desc_node is not None and desc_node.text:
                    # –û—á–∏—â–∞–µ–º –æ—Ç HTML —Ç–µ–≥–æ–≤ –∏ –±–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
                    desc_text = re.sub(r'<[^>]+>', '', desc_node.text.strip())
                    first_sentence = desc_text.split('.')[0].strip()
                    if first_sentence:
                        task_name = first_sentence
            
            # –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ—Ç –∏–º–µ–Ω–∏, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ
            if not task_name:
                task_name = f"–ó–∞–¥–∞—á–∞_{task_id}"
                
            tasks[task_id] = {
                "name": task_name,
                "id": task_id
            }
            
    except ET.ParseError as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ XML —Ñ–∞–π–ª–∞ {kurs_file_path}: {e}")
    except Exception as e:
        print(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ {kurs_file_path}: {e}")
    
    return tasks


def clean_kumir_code_from_prg(raw_prg: str) -> str:
    """
    –û—á–∏—â–∞–µ—Ç –∫–æ–¥ –ö—É–ú–∏—Ä –∏–∑ –∞—Ç—Ä–∏–±—É—Ç–∞ 'prg' —Å–æ–≥–ª–∞—Å–Ω–æ kurs_test_gen_info.md:
    1. –î–µ–∫–æ–¥–∏—Ä—É–µ—Ç HTML-—Å—É—â–Ω–æ—Å—Ç–∏
    2. –£–¥–∞–ª—è–µ—Ç –º–∞—Ä–∫–µ—Ä—ã |@protected –∏ |@hidden
    """
    # –î–µ–∫–æ–¥–∏—Ä—É–µ–º HTML-—Å—É—â–Ω–æ—Å—Ç–∏
    cleaned = html.unescape(raw_prg)
    
    # –£–¥–∞–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –∑–∞—â–∏—Ç—ã/—Å–∫—Ä—ã—Ç–∏—è
    cleaned = re.sub(r'\|@(protected|hidden)', '', cleaned)
    
    # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
    cleaned = re.sub(r'\n\s*\n', '\n\n', cleaned)
    
    return cleaned.strip()


def extract_task_name_from_kumir_code(kumir_code: str) -> Optional[str]:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –∏–∑ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –∞–ª–≥–æ—Ä–∏—Ç–º–∞."""
    lines = kumir_code.split('\n')
    for line in lines:
        line = line.strip()
        if line.startswith('–∞–ª–≥ ') and '(' in line:
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ–∂–¥—É "–∞–ª–≥ " –∏ "("
            match = re.match(r'–∞–ª–≥\s+([^(]+)', line)
            if match:
                return match.group(1).strip()
    return None


def parse_work_xml(work_file_path: Path, tasks_info: Dict[str, Dict[str, str]]) -> Dict[str, str]:
    """
    –ü–∞—Ä—Å–∏—Ç .work.xml —Ñ–∞–π–ª –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –∑–∞–¥–∞—á.
    
    –ò—â–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã <USER_PRG> –∏ <TESTED_PRG> —Å –∞—Ç—Ä–∏–±—É—Ç–æ–º 'prg',
    —Å–æ–≥–ª–∞—Å–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ, –æ–ø–∏—Å–∞–Ω–Ω–æ–π –≤ kurs_test_gen_info.md.
    
    Returns:
        Dict[task_id, cleaned_kumir_code]
    """
    solutions: Dict[str, str] = {}
    
    try:
        tree = ET.parse(work_file_path)
        root = tree.getroot()
        
        # –ò—â–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã USER_PRG –∏ TESTED_PRG
        for element_name in ["USER_PRG", "TESTED_PRG"]:
            for prg_element in root.findall(f".//{element_name}[@testId][@prg]"):
                test_id = prg_element.get("testId")
                raw_prg = prg_element.get("prg")
                
                if not test_id or not raw_prg:
                    continue
                    
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –∑–∞–¥–∞—á–∞ –∏–∑ –Ω–∞—à–µ–≥–æ –∫—É—Ä—Å–∞
                if test_id not in tasks_info:
                    print(f"‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω–æ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–π –∑–∞–¥–∞—á–∏ {test_id} –≤ {work_file_path.name}")
                    continue
                
                # –û—á–∏—â–∞–µ–º –∫–æ–¥ —Å–æ–≥–ª–∞—Å–Ω–æ info-—Ñ–∞–π–ª—É
                cleaned_code = clean_kumir_code_from_prg(raw_prg)
                
                if cleaned_code:
                    solutions[test_id] = cleaned_code
                    print(f"‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–æ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –∑–∞–¥–∞—á–∏ {test_id}: {tasks_info[test_id]['name']}")
                else:
                    print(f"‚ö†Ô∏è  –ü—É—Å—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –∑–∞–¥–∞—á–∏ {test_id}")
        
        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç TESTED_PRG –Ω–∞–¥ USER_PRG –µ—Å–ª–∏ –µ—Å—Ç—å –æ–±–∞ (–æ–±—ã—á–Ω–æ –æ–Ω–∏ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã)
                    
    except ET.ParseError as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ XML —Ñ–∞–π–ª–∞ {work_file_path}: {e}")
    except Exception as e:
        print(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ {work_file_path}: {e}")
    
    return solutions


def generate_test_file_content(course_name: str, tasks_with_solutions: Dict[str, Dict[str, str]]) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ —Å pytest-—Ç–µ—Å—Ç–∞–º–∏ –¥–ª—è –∫—É—Ä—Å–∞.
    
    Args:
        course_name: –ò–º—è –∫—É—Ä—Å–∞
        tasks_with_solutions: Dict[task_id, {name, id, solution?}]
    """
    
    # –ß–∏—Ç–∞–µ–º —à–∞–±–ª–æ–Ω —Ç–µ—Å—Ç–æ–≤
    try:
        with open(TEST_TEMPLATE_PATH, "r", encoding="utf-8") as f:
            template_content = f.read()
    except FileNotFoundError:
        print(f"‚ùå –§–∞–π–ª —à–∞–±–ª–æ–Ω–∞ {TEST_TEMPLATE_PATH} –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return ""
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞: {e}")
        return ""
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    test_functions = []
    
    for task_id, data in tasks_with_solutions.items():
        task_name = data["name"]
        solution_code = data.get("solution", "")
        
        if not solution_code:
            print(f"‚ö†Ô∏è  –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É '{task_name}' (ID: {task_id}) - –Ω–µ—Ç —Ä–µ—à–µ–Ω–∏—è")
            continue
        
        # –°–æ–∑–¥–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–º—è –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–µ—Å—Ç–∞
        safe_course_name = sanitize_filename(course_name)
        safe_task_name = sanitize_filename(task_name)
        test_func_name = f"test_{safe_course_name}_{safe_task_name}_{task_id}"
        
        # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∫–æ–¥ –¥–ª—è Python —Å—Ç—Ä–æ–∫–∏
        escaped_code = solution_code.replace('\\', '\\\\').replace("'''", "\\'\\'\\'")
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Ç–µ—Å—Ç–∞
        test_function = f'''
def {test_func_name}(run_kumir_code_func, tmp_path):
    """
    –¢–µ—Å—Ç –¥–ª—è –∑–∞–¥–∞—á–∏: {task_name} (ID: {task_id})
    –ö—É—Ä—Å: {course_name}
    
    –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: "–ó–∞–¥–∞–Ω–∏–µ –∑–∞—á—Ç–µ–Ω–æ."
    """
    kumir_code = """{escaped_code}"""
    
    file_path = tmp_path / "{safe_course_name}_{safe_task_name}_{task_id}.kum"
    with open(file_path, "w", encoding="utf-8") as f:
        f.write(kumir_code)
    
    result = run_kumir_code_func(str(file_path))
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    assert result.return_code == 0, f"–ö–æ–¥ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π: {{result.stderr_output}}"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥
    expected_output = "–ó–∞–¥–∞–Ω–∏–µ –∑–∞—á—Ç–µ–Ω–æ.\\n"
    assert result.stdout_output == expected_output, f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –≤—ã–≤–æ–¥.\\n–û–∂–∏–¥–∞–ª–æ—Å—å: {{expected_output!r}}\\n–ü–æ–ª—É—á–µ–Ω–æ: {{result.stdout_output!r}}"
'''
        
        test_functions.append(test_function)
    
    if not test_functions:
        print(f"‚ö†Ô∏è  –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤ –∫—É—Ä—Å–µ {course_name}")
        return ""
    
    # –°–æ–±–∏—Ä–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π —Ñ–∞–π–ª
    # –ë–µ—Ä–µ–º —à–∞–±–ª–æ–Ω –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–∞—à–∏ —Ç–µ—Å—Ç—ã –≤ –∫–æ–Ω–µ—Ü
    final_content = template_content.rstrip() + "\n\n"
    final_content += f"# –ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è –∫—É—Ä—Å–∞: {course_name}\n"
    final_content += f"# –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n"
    final_content += "\n".join(test_functions)
    final_content += "\n"
    
    return final_content


def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ —Ç–µ—Å—Ç–æ–≤."""
    start_time = datetime.now()
    print(f"üöÄ [{start_time.strftime('%Y-%m-%d %H:%M:%S')}] –ù–∞—á–∏–Ω–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ç–µ—Å—Ç–æ–≤...")
    print(f"üìÅ –ò—Å—Ö–æ–¥–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {POLYAKOV_KURS_WORK_DIR}")
    print(f"üìÅ –¶–µ–ª–µ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {GENERATED_TESTS_DIR}")
    
    course_count = 0
    generated_files_count = 0
    total_tests_count = 0
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –∫—É—Ä—Å
    for course_dir in POLYAKOV_KURS_WORK_DIR.iterdir():
        if not course_dir.is_dir():
            continue
            
        course_name = course_dir.name
        print(f"\nüìö –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫—É—Ä—Å: {course_name}")
        
        # –ò—â–µ–º .kurs.xml —Ñ–∞–π–ª
        kurs_file = None
        for pattern in [f"{course_name}.kurs.xml", "*.kurs.xml"]:
            matches = list(course_dir.glob(pattern))
            if matches:
                kurs_file = matches[0]
                break
        
        if not kurs_file:
            print(f"‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω .kurs.xml —Ñ–∞–π–ª –≤ {course_dir}")
            continue
        
        # –ò—â–µ–º .work.xml —Ñ–∞–π–ª
        work_file = None
        for pattern in [f"–ü–æ–ª—è–∫–æ–≤_{course_name}.work.xml", "*.work.xml"]:
            matches = list(course_dir.glob(pattern))
            if matches:
                work_file = matches[0]
                break
        
        if not work_file:
            print(f"‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω .work.xml —Ñ–∞–π–ª –≤ {course_dir}")
            continue
        
        print(f"üìÑ –ö—É—Ä—Å: {kurs_file.name}")
        print(f"üìÑ –†–µ—à–µ–Ω–∏—è: {work_file.name}")
        
        # –ü–∞—Ä—Å–∏–º —Ñ–∞–π–ª—ã
        tasks_info = parse_kurs_xml(kurs_file)
        if not tasks_info:
            print(f"‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –∑–∞–¥–∞—á –≤ {kurs_file.name}")
            continue
        
        print(f"üìù –ù–∞–π–¥–µ–Ω–æ –∑–∞–¥–∞—á –≤ –∫—É—Ä—Å–µ: {len(tasks_info)}")
        
        solutions = parse_work_xml(work_file, tasks_info)
        print(f"‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–æ —Ä–µ—à–µ–Ω–∏–π: {len(solutions)}")
        
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
        tasks_with_solutions = {}
        for task_id, task_data in tasks_info.items():
            combined_data = task_data.copy()
            if task_id in solutions:
                combined_data["solution"] = solutions[task_id]
            tasks_with_solutions[task_id] = combined_data
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ—Å—Ç—ã
        test_content = generate_test_file_content(course_name, tasks_with_solutions)
        if not test_content:
            print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è {course_name}")
            continue
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
        test_file_name = f"test_{sanitize_filename(course_name)}.py"
        test_file_path = GENERATED_TESTS_DIR / test_file_name
        
        try:
            with open(test_file_path, "w", encoding="utf-8") as f:
                f.write(test_content)
            
            tests_in_file = len([task for task in tasks_with_solutions.values() if "solution" in task])
            print(f"‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Ñ–∞–π–ª: {test_file_path.name} ({tests_in_file} —Ç–µ—Å—Ç–æ–≤)")
            
            generated_files_count += 1
            total_tests_count += tests_in_file
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ {test_file_path}: {e}")
        
        course_count += 1
    
    # –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    end_time = datetime.now()
    duration = end_time - start_time
    
    print(f"\nüéâ [{end_time.strftime('%Y-%m-%d %H:%M:%S')}] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
    print(f"üìä –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∫—É—Ä—Å–æ–≤: {course_count}")
    print(f"üìä –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: {generated_files_count}")
    print(f"üìä –í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: {total_tests_count}")
    print(f"‚è±Ô∏è  –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {duration}")


if __name__ == "__main__":
    main()

    lines = template_content.split('\n')
    insert_after_line_index = -1 

    # –ò—â–µ–º –º–µ—Å—Ç–æ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏: –ø–æ—Å–ª–µ –≤—Å–µ—Ö –∏–º–ø–æ—Ä—Ç–æ–≤ –∏ —Ñ–∏–∫—Å—Ç—É—Ä, –Ω–æ –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º —Ç–µ—Å—Ç–æ–º
    # –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞, –µ—Å–ª–∏ —à–∞–±–ª–æ–Ω –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ—Å—Ç–æ–≤
    
    last_import_or_fixture_line = 0
    first_test_line = -1

    for i, line in enumerate(lines):
        if line.strip().startswith("import ") or line.strip().startswith("from "):
            last_import_or_fixture_line = i
        if line.strip().startswith("@pytest.fixture"): # –£—á–∏—Ç—ã–≤–∞–µ–º —Ñ–∏–∫—Å—Ç—É—Ä—ã
             # –ò—â–µ–º –∫–æ–Ω–µ—Ü —Ñ–∏–∫—Å—Ç—É—Ä—ã (—Å–ª–µ–¥—É—é—â–∞—è –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ –Ω–∞—á–∞–ª–æ def)
            for j in range(i + 1, len(lines)):
                if not lines[j].strip() or lines[j].strip().startswith("def "):
                    last_import_or_fixture_line = j -1 # –ö–æ–Ω–µ—Ü —Ñ–∏–∫—Å—Ç—É—Ä—ã - –ø—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–æ–∫–∞
                    break
            else: # –ï—Å–ª–∏ —Ñ–∏–∫—Å—Ç—É—Ä–∞ –∏–¥–µ—Ç –¥–æ –∫–æ–Ω—Ü–∞ —Ñ–∞–π–ª–∞
                last_import_or_fixture_line = len(lines) -1


        if line.strip().startswith("def test_") and first_test_line == -1:
            first_test_line = i
            break # –ù–∞—à–ª–∏ –ø–µ—Ä–≤—ã–π —Ç–µ—Å—Ç, –¥–∞–ª—å—à–µ –Ω–µ –∏—â–µ–º

    if first_test_line != -1:
        # –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–µ—Å—Ç—ã, –≤—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º –∏–∑ –Ω–∏—Ö, –Ω–æ –ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–æ–≤/—Ñ–∏–∫—Å—Ç—É—Ä
        insert_after_line_index = max(last_import_or_fixture_line, 0) if first_test_line == 0 else first_test_line -1
        # –ë–µ—Ä–µ–º –≤—Å–µ –¥–æ —ç—Ç–æ–π —Ç–æ—á–∫–∏
        header_lines = lines[:insert_after_line_index + 1]
         # –ï—Å–ª–∏ –º—ã –≤—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º —Ç–µ—Å—Ç–æ–º, —Ç–æ —Å—Ç–∞—Ä—ã–µ —Ç–µ—Å—Ç—ã –Ω–∞–º –Ω–µ –Ω—É–∂–Ω—ã
        if insert_after_line_index + 1 < len(lines) and lines[insert_after_line_index+1].strip().startswith("def test_"):
             pass # –°—Ç–∞—Ä—ã–µ —Ç–µ—Å—Ç—ã –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã
        elif first_test_line > 0 : # –ï—Å–ª–∏ –ø–µ—Ä–≤—ã–π —Ç–µ—Å—Ç –Ω–µ –≤ –Ω–∞—á–∞–ª–µ, —Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –¥–æ –Ω–µ–≥–æ
             header_lines = lines[:first_test_line]


    elif last_import_or_fixture_line > 0:
        # –ï—Å–ª–∏ —Ç–µ—Å—Ç–æ–≤ –Ω–µ—Ç, –Ω–æ –µ—Å—Ç—å –∏–º–ø–æ—Ä—Ç—ã/—Ñ–∏–∫—Å—Ç—É—Ä—ã, –≤—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ –Ω–∏—Ö
        insert_after_line_index = last_import_or_fixture_line
        header_lines = lines[:insert_after_line_index + 1]
    else:
        # –ï—Å–ª–∏ —à–∞–±–ª–æ–Ω –ø–æ—á—Ç–∏ –ø—É—Å—Ç–æ–π (–Ω–µ—Ç –Ω–∏ —Ç–µ—Å—Ç–æ–≤, –Ω–∏ –∑–Ω–∞—á–∏–º—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤)
        # –ü—Ä–æ—Å—Ç–æ –±–µ—Ä–µ–º –≤—Å–µ, —á—Ç–æ –µ—Å—Ç—å (–º–æ–∂–µ—Ç –±—ã—Ç—å –∫–æ–ø–∏—Ä–∞–π—Ç –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏)
        header_lines = lines
        insert_after_line_index = len(lines) -1


    # –ï—Å–ª–∏ –≤ —à–∞–±–ª–æ–Ω–µ –≤–æ–æ–±—â–µ –Ω–µ –±—ã–ª–æ —Å—Ç—Ä–æ–∫ (–º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ, –Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ)
    if not lines:
        header_lines = ["import pytest", "from pathlib import Path"] # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã
        insert_after_line_index = len(header_lines) -1


    header = "\n".join(header_lines)
    if not header.strip() and not test_functions_code: # –ï—Å–ª–∏ –∏ —à–∞–ø–∫–∞ –ø—É—Å—Ç–∞—è, –∏ —Ç–µ—Å—Ç–æ–≤ –Ω–µ—Ç
        return "" # –ù–µ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª

    # –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –ø–æ—Å–ª–µ —à–∞–ø–∫–∏, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ –ø—É—Å—Ç–∞—è –∏ –µ—Å—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏
    if header.strip() and test_functions_code:
        header += "\n"

    generated_notice = f"# –§–∞–π–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–º generate_course_tests.py\n"
    generated_notice += f"# –ö—É—Ä—Å: {course_name}\n\n"
    
    final_code = generated_notice + header + "\n\n" + "\n\n".join(test_functions_code)
    
    return final_code.strip() + "\n" # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤ –∫–æ–Ω—Ü–µ –µ—Å—Ç—å –æ–¥–Ω–∞ –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞

def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤."""
    print(f"–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –∫—É—Ä—Å–∞–º–∏: {POLYAKOV_KURS_WORK_DIR}")
    
    found_courses_count = 0
    generated_files_count = 0

    for course_dir_item in POLYAKOV_KURS_WORK_DIR.iterdir():
        if course_dir_item.is_dir():
            course_name = course_dir_item.name
            print(f"  –ù–∞–π–¥–µ–Ω –∫—É—Ä—Å: {course_name}")
            found_courses_count += 1
            
            # –ò—â–µ–º .kurs.xml —Ñ–∞–π–ª. –ò–º—è —Ñ–∞–π–ª–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ —Ç–æ—á–Ω–æ —Ç–∞–∫–∏–º –∂–µ, –∫–∞–∫ –∏–º—è –ø–∞–ø–∫–∏.
            # –ù–∞–ø—Ä–∏–º–µ—Ä, –ø–∞–ø–∫–∞ "arrkum", —Ñ–∞–π–ª "–ú–∞—Å—Å–∏–≤—ã.kurs.xml"
            kurs_file: Optional[Path] = None
            possible_kurs_files = list(course_dir_item.glob("*.kurs.xml"))
            if possible_kurs_files:
                kurs_file = possible_kurs_files[0] # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π
                if len(possible_kurs_files) > 1:
                    print(f"    –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ù–∞–π–¥–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ .kurs.xml —Ñ–∞–π–ª–æ–≤ –≤ {course_dir_item}. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: {kurs_file.name}")
            
            work_file: Optional[Path] = None
            possible_work_files = list(course_dir_item.glob("*.work.xml"))
            if possible_work_files:
                work_file = possible_work_files[0] # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π
                if len(possible_work_files) > 1:
                    print(f"    –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ù–∞–π–¥–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ .work.xml —Ñ–∞–π–ª–æ–≤ –≤ {course_dir_item}. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: {work_file.name}")

            if kurs_file and kurs_file.exists() and work_file and work_file.exists():
                print(f"    –§–∞–π–ª –æ–ø–∏—Å–∞–Ω–∏—è –∫—É—Ä—Å–∞: {kurs_file.name}")
                print(f"    –§–∞–π–ª —Ä–µ—à–µ–Ω–∏–π: {work_file.name}")
                
                tasks_info = parse_kurs_xml(kurs_file)
                if not tasks_info:
                    print(f"    –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ù–µ –Ω–∞–π–¥–µ–Ω–æ –∑–∞–¥–∞—á –≤ {kurs_file.name} –¥–ª—è –∫—É—Ä—Å–∞ '{course_name}'. –ü—Ä–æ–ø—É—Å–∫.")
                    continue
                    
                solutions = parse_work_xml(work_file, tasks_info)
                # –ù–µ –±—É–¥–µ–º –≤—ã–≤–æ–¥–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ—Ç —Ä–µ—à–µ–Ω–∏–π, —Ç.–∫. parse_work_xml —É–∂–µ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç
                                    
                tasks_with_solutions: Dict[str, Dict[str,str]] = {}
                for task_id, task_data in tasks_info.items():
                    if task_id in solutions and solutions[task_id]: # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –Ω–µ –ø—É—Å—Ç–æ–µ
                        tasks_with_solutions[task_id] = {
                            "name": task_data["name"],
                            "solution": solutions[task_id]
                        }
                    else:
                        print(f"    –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ù–µ—Ç —Ä–µ—à–µ–Ω–∏—è –∏–ª–∏ –æ–Ω–æ –ø—É—Å—Ç–æ–µ –¥–ª—è –∑–∞–¥–∞—á–∏ '{task_data['name']}' (ID: {task_id}) –≤ –∫—É—Ä—Å–µ '{course_name}'.")

                if not tasks_with_solutions:
                    print(f"    –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ù–µ—Ç –∑–∞–¥–∞—á —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ —Ä–µ—à–µ–Ω–∏—è–º–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤ –≤ –∫—É—Ä—Å–µ '{course_name}'. –ü—Ä–æ–ø—É—Å–∫.")
                    continue

                test_file_name = f"test_{sanitize_filename(course_name)}.py"
                test_file_path = GENERATED_TESTS_DIR / test_file_name
                
                print(f"    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–∞ —Ç–µ—Å—Ç–∞: {test_file_path}")
                
                test_content = generate_test_file_content(course_name, tasks_with_solutions)
                
                if test_content: # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–∞–π–ª, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —á—Ç–æ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
                    with open(test_file_path, "w", encoding="utf-8") as f:
                        f.write(test_content)
                    print(f"    –§–∞–π–ª —Ç–µ—Å—Ç–∞ {test_file_path.name} —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω.")
                    generated_files_count +=1
                else:
                    print(f"    –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Ñ–∞–π–ª–∞ —Ç–µ—Å—Ç–∞ {test_file_path.name} –Ω–µ –±—ã–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω (–≤–æ–∑–º–æ–∂–Ω–æ, –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —à–∞–±–ª–æ–Ω–∞ –∏–ª–∏ –∑–∞–¥–∞—á).")
                
            else:
                if not (kurs_file and kurs_file.exists()):
                    print(f"    –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –§–∞–π–ª .kurs.xml –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ {course_dir_item}")
                if not (work_file and work_file.exists()):
                     print(f"    –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –§–∞–π–ª .work.xml –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ {course_dir_item}")
    
    print(f"\n–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ù–∞–π–¥–µ–Ω–æ –∫—É—Ä—Å–æ–≤: {found_courses_count}.")
    print(f"–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ —Ñ–∞–π–ª–æ–≤ —Å —Ç–µ—Å—Ç–∞–º–∏: {generated_files_count}.")

if __name__ == "__main__":
    main()

import xml.etree.ElementTree as ET
import re
from pathlib import Path
from typing import Dict, List # –£–±—Ä–∞–ª Any –∏ Optional
from datetime import datetime

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
POLYAKOV_KURS_WORK_DIR = Path("c:/Users/Bormotoon/VSCodeProjects/PyRobot/polyakov_kurs_work")
GENERATED_TESTS_DIR = Path("c:/Users/Bormotoon/VSCodeProjects/PyRobot/tests/generated_course_tests")
TEST_TEMPLATE_PATH = Path("c:/Users/Bormotoon/VSCodeProjects/PyRobot/tests/test_polyakov_kum.py")

GENERATED_TESTS_DIR.mkdir(parents=True, exist_ok=True)

def sanitize_filename(name: str) -> str:
    """–û—á–∏—â–∞–µ—Ç –∏–º—è —Ñ–∞–π–ª–∞ –æ—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤."""
    name = re.sub(r'[\/*?:"<>|]',"", name)
    name = name.replace(" ", "_")
    return name

def parse_kurs_xml(kurs_file_path: Path) -> Dict[str, Dict[str, str]]:
    """–ü–∞—Ä—Å–∏—Ç .kurs.xml —Ñ–∞–π–ª –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–¥–∞—á–∞—Ö."""
    tasks: Dict[str, Dict[str, str]] = {}
    try:
        tree = ET.parse(kurs_file_path)
        root = tree.getroot()
        
        # –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –∏–º–µ–Ω –¥–ª—è –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –≤—Ä–æ–¥–µ xml:id
        ns = {'xml': 'http://www.w3.org/XML/1998/namespace'}

        for task_node in root.findall(".//T"): # –ò—â–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã <T>
            task_id = task_node.get(f"{{{ns['xml']}}}id")
            if not task_id: # –ü—Ä–æ–±—É–µ–º –±–µ–∑ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –∏–º–µ–Ω
                task_id = task_node.get("id")

            if task_id:
                # –ó–∞–¥–∞—á–∏ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å –Ω–µ–ø—É—Å—Ç–æ–π —ç–ª–µ–º–µ–Ω—Ç <PROGRAM>
                program_node = task_node.find("PROGRAM")
                if program_node is not None and program_node.text and program_node.text.strip():
                    # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∑–∞–¥–∞—á–∏
                    task_name_attr = task_node.get(f"{{{ns['xml']}}}name")
                    if not task_name_attr:
                        task_name_attr = task_node.get("name")

                    current_task_name = task_name_attr
                    
                    # –ï—Å–ª–∏ –∏–º—è –∏–∑ –∞—Ç—Ä–∏–±—É—Ç–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, —Å–ª–∏—à–∫–æ–º –æ–±—â–µ–µ, –∏–ª–∏ –ø–æ—Ö–æ–∂–µ –Ω–∞ –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–µ–Ω–Ω–æ–µ,
                    # –ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –µ–≥–æ –∏–∑ <DESC>
                    if not current_task_name or \
                       re.fullmatch(r"\d+-\d+", current_task_name or "") or \
                       (current_task_name or "").startswith("–ó–∞–¥–∞—á–∞_"):
                        
                        desc_node = task_node.find("DESC")
                        if desc_node is not None and desc_node.text:
                            # –û—á–∏—â–∞–µ–º –æ—Ç HTML —Ç–µ–≥–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, <BR>) –∏ –±–µ—Ä–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É/–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
                            desc_text_cleaned = re.sub('<[^<]+?>', '', desc_node.text.strip())
                            name_from_desc = desc_text_cleaned.split('\\n')[0].split('.')[0].strip()
                            if name_from_desc: # –ï—Å–ª–∏ —É–¥–∞–ª–æ—Å—å —á—Ç–æ-—Ç–æ –∏–∑–≤–ª–µ—á—å
                                current_task_name = name_from_desc
                    
                    # –ï—Å–ª–∏ –∏–º—è –≤—Å–µ –µ—â–µ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ
                    if not current_task_name:
                        current_task_name = f"–ó–∞–¥–∞—á–∞_{task_id}"
                    
                    tasks[task_id] = {"name": current_task_name, "id": task_id}
                # else:
                #     # –≠–ª–µ–º–µ–Ω—Ç <T> —Å ID, –Ω–æ –±–µ–∑ <PROGRAM> –∏–ª–∏ —Å –ø—É—Å—Ç—ã–º <PROGRAM> - —ç—Ç–æ, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, —Ä–∞–∑–¥–µ–ª, –∞ –Ω–µ –∑–∞–¥–∞—á–∞.
                #     # –õ–∏–±–æ –∑–∞–¥–∞—á–∞, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–π –Ω–µ —É–∫–∞–∑–∞–Ω —Ñ–∞–π–ª —Å –∫–æ–¥–æ–º. –¢–∞–∫–∏–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º.
                #     # print(f"DEBUG: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É–∑–µ–ª T —Å ID {task_id} - –Ω–µ—Ç PROGAM –∏–ª–∏ –æ–Ω –ø—É—Å—Ç.")
                #     pass
            # else:
            #     # –≠–ª–µ–º–µ–Ω—Ç <T> –±–µ–∑ ID - —ç—Ç–æ —Ç–æ—á–Ω–æ –Ω–µ –∑–∞–¥–∞—á–∞, –∫–æ—Ç–æ—Ä—É—é –º—ã –∏—â–µ–º.
            #     # print(f"DEBUG: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É–∑–µ–ª T –±–µ–∑ ID.")
            #     pass

    except ET.ParseError as e:
        print(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ XML –≤ —Ñ–∞–π–ª–µ {kurs_file_path}: {e}")
    except Exception as e:
        print(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ {kurs_file_path}: {e}")
    return tasks

def parse_work_xml(work_file_path: Path, tasks_info: Dict[str, Dict[str, str]]) -> Dict[str, str]:
    """–ü–∞—Ä—Å–∏—Ç .work.xml —Ñ–∞–π–ª –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –∑–∞–¥–∞—á."""
    solutions: Dict[str, str] = {}
    try:
        tree = ET.parse(work_file_path)
        root = tree.getroot()
        for task_solution_element in root.findall(".//task_solution"):
            task_id = task_solution_element.get("id")
            if task_id and task_id in tasks_info:
                source_element = task_solution_element.find(".//source")
                if source_element is not None and source_element.text:
                    solution_code = source_element.text.strip()
                    
                    # –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –æ–±–µ—Ä—Ç–∫–∏ –ö–£–ú–ò–†–∞
                    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –±–æ–ª–µ–µ –¥–ª–∏–Ω–Ω—É—é –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—é —Å \n, –ø–æ—Ç–æ–º —Å \n
                    # –≠—Ç–æ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ XML –ø–∞—Ä—Å–µ—Ä –ø–æ-—Ä–∞–∑–Ω–æ–º—É –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
                    patterns_to_remove_start = [
                        "–∞–ª–≥ –ø—Ä–æ–≥—Ä–∞–º–º–∞\n–Ω–∞—á\n", # –° –ª–∏—Ç–µ—Ä–∞–ª—å–Ω—ã–º \n
                        "–∞–ª–≥ –ø—Ä–æ–≥—Ä–∞–º–º–∞\n–Ω–∞—á\n"   # –° —Ä–µ–∞–ª—å–Ω—ã–º \n
                    ]
                    patterns_to_remove_end = [
                        "\n–∫–æ–Ω", # –° –ª–∏—Ç–µ—Ä–∞–ª—å–Ω—ã–º \n
                        "\n–∫–æ–Ω"   # –° —Ä–µ–∞–ª—å–Ω—ã–º \n
                    ]

                    for pattern in patterns_to_remove_start:
                        if solution_code.startswith(pattern):
                            solution_code = solution_code[len(pattern):]
                            break
                    
                    for pattern in patterns_to_remove_end:
                        if solution_code.endswith(pattern):
                            solution_code = solution_code[:-len(pattern)]
                            break
                            
                    solutions[task_id] = solution_code.strip()
                else:
                    print(f"–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ù–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø—É—Å—Ç —ç–ª–µ–º–µ–Ω—Ç <source> –¥–ª—è –∑–∞–¥–∞—á–∏ {task_id} –≤ {work_file_path}")
            elif task_id:
                print(f"–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ù–∞–π–¥–µ–Ω–æ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–π –∑–∞–¥–∞—á–∏ {task_id} –≤ {work_file_path} (–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ .kurs.xml)")

    except ET.ParseError as e:
        print(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ {work_file_path}: {e}")
    return solutions

def generate_test_file_content(course_name: str, tasks_with_solutions: Dict[str, Dict[str, str]]) -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ —Å pytest-—Ç–µ—Å—Ç–∞–º–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∫—É—Ä—Å–∞."""
    
    try:
        with open(TEST_TEMPLATE_PATH, "r", encoding="utf-8") as f:
            template_content = f.read()
    except FileNotFoundError:
        print(f"–û—à–∏–±–∫–∞: –§–∞–π–ª —à–∞–±–ª–æ–Ω–∞ {TEST_TEMPLATE_PATH} –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –∏–ª–∏ –≤–æ–∑–±—É–∂–¥–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –¥–ª—è —ç—Ç–æ–≥–æ –∫—É—Ä—Å–∞
        return ""


    test_functions_code: List[str] = []
    for task_id, data in tasks_with_solutions.items():
        task_name = data["name"]
        solution_code = data.get("solution", "") # –ü–æ–ª—É—á–∞–µ–º —Ä–µ—à–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
        
        if not solution_code:
            print(f"–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–¥ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –∑–∞–¥–∞—á–∏ '{task_name}' (ID: {task_id}) –≤ –∫—É—Ä—Å–µ '{course_name}'. –¢–µ—Å—Ç –±—É–¥–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω.")
            continue

        escaped_solution_code = solution_code.replace("\\", "\\\\").replace("'", "\'").replace("\n", "\\n").replace('"', '''"''')
        
        test_func_name = f"test_{sanitize_filename(course_name)}_{sanitize_filename(task_name)}_{task_id}"
        temp_kum_file_name = sanitize_filename(f"{course_name}_{task_name}_{task_id}.kum")
        
        test_function = f"""
def {test_func_name}(run_kumir_code_func, tmp_path: Path):
    kumir_code = '''{escaped_solution_code}'''
    file_path = tmp_path / "{temp_kum_file_name}"
    with open(file_path, "w", encoding="utf-8") as f:
        f.write(kumir_code)
    
    result = run_kumir_code_func(str(file_path))
    assert result.return_code == 0, f"–ö–æ–¥ –ö—É–ú–∏—Ä–∞ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π: {{result.stderr_output}}\n–ö–æ–¥:\n{{kumir_code}}"
"""
        test_functions_code.append(test_function)

    lines = template_content.split('\n')
    insert_after_line_index = -1 

    # –ò—â–µ–º –º–µ—Å—Ç–æ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏: –ø–æ—Å–ª–µ –≤—Å–µ—Ö –∏–º–ø–æ—Ä—Ç–æ–≤ –∏ —Ñ–∏–∫—Å—Ç—É—Ä, –Ω–æ –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º —Ç–µ—Å—Ç–æ–º
    # –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞, –µ—Å–ª–∏ —à–∞–±–ª–æ–Ω –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ—Å—Ç–æ–≤
    
    last_import_or_fixture_line = 0
    first_test_line = -1

    for i, line in enumerate(lines):
        if line.strip().startswith("import ") or line.strip().startswith("from "):
            last_import_or_fixture_line = i
        if line.strip().startswith("@pytest.fixture"): # –£—á–∏—Ç—ã–≤–∞–µ–º —Ñ–∏–∫—Å—Ç—É—Ä—ã
             # –ò—â–µ–º –∫–æ–Ω–µ—Ü —Ñ–∏–∫—Å—Ç—É—Ä—ã (—Å–ª–µ–¥—É—é—â–∞—è –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ –Ω–∞—á–∞–ª–æ def)
            for j in range(i + 1, len(lines)):
                if not lines[j].strip() or lines[j].strip().startswith("def "):
                    last_import_or_fixture_line = j -1 # –ö–æ–Ω–µ—Ü —Ñ–∏–∫—Å—Ç—É—Ä—ã - –ø—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–æ–∫–∞
                    break
            else: # –ï—Å–ª–∏ —Ñ–∏–∫—Å—Ç—É—Ä–∞ –∏–¥–µ—Ç –¥–æ –∫–æ–Ω—Ü–∞ —Ñ–∞–π–ª–∞
                last_import_or_fixture_line = len(lines) -1


        if line.strip().startswith("def test_") and first_test_line == -1:
            first_test_line = i
            break # –ù–∞—à–ª–∏ –ø–µ—Ä–≤—ã–π —Ç–µ—Å—Ç, –¥–∞–ª—å—à–µ –Ω–µ –∏—â–µ–º

    if first_test_line != -1:
        # –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–µ—Å—Ç—ã, –≤—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º –∏–∑ –Ω–∏—Ö, –Ω–æ –ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–æ–≤/—Ñ–∏–∫—Å—Ç—É—Ä
        insert_after_line_index = max(last_import_or_fixture_line, 0) if first_test_line == 0 else first_test_line -1
        # –ë–µ—Ä–µ–º –≤—Å–µ –¥–æ —ç—Ç–æ–π —Ç–æ—á–∫–∏
        header_lines = lines[:insert_after_line_index + 1]
         # –ï—Å–ª–∏ –º—ã –≤—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º —Ç–µ—Å—Ç–æ–º, —Ç–æ —Å—Ç–∞—Ä—ã–µ —Ç–µ—Å—Ç—ã –Ω–∞–º –Ω–µ –Ω—É–∂–Ω—ã
        if insert_after_line_index + 1 < len(lines) and lines[insert_after_line_index+1].strip().startswith("def test_"):
             pass # –°—Ç–∞—Ä—ã–µ —Ç–µ—Å—Ç—ã –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã
        elif first_test_line > 0 : # –ï—Å–ª–∏ –ø–µ—Ä–≤—ã–π —Ç–µ—Å—Ç –Ω–µ –≤ –Ω–∞—á–∞–ª–µ, —Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –¥–æ –Ω–µ–≥–æ
             header_lines = lines[:first_test_line]
        else: # –ï—Å–ª–∏ —Ç–µ—Å—Ç–æ–≤ –Ω–µ—Ç –∏–ª–∏ –æ–Ω–∏ –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ, –±–µ—Ä–µ–º –≤—Å–µ –¥–æ –∫–æ–Ω—Ü–∞ –∏–º–ø–æ—Ä—Ç–æ–≤/—Ñ–∏–∫—Å—Ç—É—Ä
            header_lines = lines[:last_import_or_fixture_line + 1]
            
        # –°–æ–±–∏—Ä–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
        # –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–∏–º–ø–æ—Ä—Ç—ã, —Ñ–∏–∫—Å—Ç—É—Ä—ã –∏–∑ —à–∞–±–ª–æ–Ω–∞)
        # –ó–∞—Ç–µ–º –Ω–æ–≤—ã–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
        final_content = "\\n".join(header_lines) + "\\n\\n" + "\\n\\n".join(test_functions_code) + "\\n"
    
    else: # –ï—Å–ª–∏ –≤ —à–∞–±–ª–æ–Ω–µ –≤–æ–æ–±—â–µ –Ω–µ—Ç —Ç–µ—Å—Ç–æ–≤ (def test_)
        # –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –ø–æ—Å–ª–µ –≤—Å–µ—Ö –∏–º–ø–æ—Ä—Ç–æ–≤ –∏ —Ñ–∏–∫—Å—Ç—É—Ä
        final_content = "\\n".join(lines[:last_import_or_fixture_line + 1]) + "\\n\\n" + "\\n\\n".join(test_functions_code) + "\\n"

    return final_content

def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤."""
    start_time = datetime.now()
    print(f"[{start_time.strftime('%Y-%m-%d %H:%M:%S')}] –ù–∞—á–∞–ª–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤...")

    GENERATED_TESTS_DIR.mkdir(parents=True, exist_ok=True) # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

    course_count = 0
    generated_test_files_count = 0

    for kurs_dir in POLYAKOV_KURS_WORK_DIR.iterdir():
        if kurs_dir.is_dir():
            course_name = kurs_dir.name
            print(f"  –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫—É—Ä—Å–∞: {course_name}")

            kurs_file = kurs_dir / f"{course_name}.kurs.xml" # –û–∂–∏–¥–∞–µ–º–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ –∫—É—Ä—Å–∞
            # –ò–Ω–æ–≥–¥–∞ –∏–º—è —Ñ–∞–π–ª–∞ –∫—É—Ä—Å–∞ –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç –∏–º–µ–Ω–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, "–ú–∞—Å—Å–∏–≤—ã.kurs.xml"
            # –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ .kurs.xml —Ñ–∞–π–ª –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, –µ—Å–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∏–º—è –Ω–µ –ø–æ–¥–æ—à–ª–æ
            if not kurs_file.exists():
                found_kurs_files = list(kurs_dir.glob("*.kurs.xml"))
                if found_kurs_files:
                    kurs_file = found_kurs_files[0] # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π
                else:
                    print(f"    –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ù–µ –Ω–∞–π–¥–µ–Ω .kurs.xml —Ñ–∞–π–ª –¥–ª—è –∫—É—Ä—Å–∞ {course_name}. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º.")
                    continue
            
            work_file = kurs_dir / f"–ü–æ–ª—è–∫–æ–≤_{course_name}.work.xml" # –û–∂–∏–¥–∞–µ–º–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ —Å —Ä–µ—à–µ–Ω–∏—è–º–∏
            # –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è .work.xml
            if not work_file.exists():
                found_work_files = list(kurs_dir.glob("*.work.xml"))
                if found_work_files:
                    work_file = found_work_files[0]
                else:
                    print(f"    –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ù–µ –Ω–∞–π–¥–µ–Ω .work.xml —Ñ–∞–π–ª –¥–ª—è –∫—É—Ä—Å–∞ {course_name}. –†–µ—à–µ–Ω–∏—è –Ω–µ –±—É–¥—É—Ç –∏–∑–≤–ª–µ—á–µ–Ω—ã.")
                    # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ—Ç —Ñ–∞–π–ª–∞ —Ä–µ—à–µ–Ω–∏–π, –∑–∞–¥–∞—á–∏ –∏–∑ .kurs.xml –≤—Å–µ —Ä–∞–≤–Ω–æ –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω—ã
                    # –ù–æ —Ç–µ—Å—Ç—ã –¥–ª—è –Ω–∏—Ö –Ω–µ –±—É–¥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —ç—Ç–∞–ª–æ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞.
                    # –í generate_test_file_content –µ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ä–µ—à–µ–Ω–∏—è.
                    pass # work_file –æ—Å—Ç–∞–Ω–µ—Ç—Å—è None –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–º, parse_work_xml –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç —ç—Ç–æ

            tasks_info = parse_kurs_xml(kurs_file)
            if not tasks_info:
                print(f"    –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ù–µ –Ω–∞–π–¥–µ–Ω–æ –∑–∞–¥–∞—á –≤ {kurs_file.name} –¥–ª—è –∫—É—Ä—Å–∞ {course_name}. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ç–µ—Å—Ç–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –∫—É—Ä—Å–∞.")
                continue

            solutions: Dict[str, str] = {}
            if work_file and work_file.exists():
                 solutions = parse_work_xml(work_file, tasks_info)
            else:
                print(f"    –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: –§–∞–π–ª —Ä–µ—à–µ–Ω–∏–π {work_file.name if work_file else '–Ω–µ —É–∫–∞–∑–∞–Ω'} –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –¢–µ—Å—Ç—ã –±—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –±–µ–∑ —ç—Ç–∞–ª–æ–Ω–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π.")


            tasks_with_solutions: Dict[str, Dict[str, str]] = {}
            for task_id, task_data in tasks_info.items():
                tasks_with_solutions[task_id] = task_data.copy() # –ö–æ–ø–∏—Ä—É–µ–º, —á—Ç–æ–±—ã –Ω–µ –∏–∑–º–µ–Ω—è—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π tasks_info
                if task_id in solutions:
                    tasks_with_solutions[task_id]["solution"] = solutions[task_id] # FIX: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                else:
                    # –ï—Å–ª–∏ —Ä–µ—à–µ–Ω–∏—è –Ω–µ—Ç, –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–ª–µ "solution" –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º –∏–ª–∏ None
                    # –§—É–Ω–∫—Ü–∏—è generate_test_file_content —ç—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç
                    print(f"      –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: –î–ª—è –∑–∞–¥–∞—á–∏ '{task_data['name']}' (ID: {task_id}) –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —Ä–µ—à–µ–Ω–∏–µ –≤ {work_file.name if work_file else '—Ñ–∞–π–ª–µ —Ä–µ—à–µ–Ω–∏–π'}.")


            if not any("\"solution\"" in data for data in tasks_with_solutions.values()):
                print(f"    –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –î–ª—è –∫—É—Ä—Å–∞ {course_name} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –∑–∞–¥–∞—á. –§–∞–π–ª —Ç–µ—Å—Ç–æ–≤ –Ω–µ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω.")
                continue

            test_content = generate_test_file_content(course_name, tasks_with_solutions)

            if test_content: # –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω
                test_file_name = f"test_{sanitize_filename(course_name)}.py"
                test_file_path = GENERATED_TESTS_DIR / test_file_name
                try:
                    with open(test_file_path, "w", encoding="utf-8") as f:
                        f.write(test_content)
                    print(f"    –£—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Ñ–∞–π–ª —Ç–µ—Å—Ç–æ–≤: {test_file_path}")
                    generated_test_files_count += 1
                except IOError as e:
                    print(f"    –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ —Ñ–∞–π–ª–∞ —Ç–µ—Å—Ç–æ–≤ {test_file_path}: {e}")
            else:
                print(f"    –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Ñ–∞–π–ª–∞ —Ç–µ—Å—Ç–æ–≤ –∫—É—Ä—Å–∞ {course_name} –Ω–µ –±—ã–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω (–≤–æ–∑–º–æ–∂–Ω–æ, –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —à–∞–±–ª–æ–Ω–∞ –∏–ª–∏ –∑–∞–¥–∞—á —Å —Ä–µ—à–µ–Ω–∏—è–º–∏).")

            course_count += 1
    
    end_time = datetime.now()
    duration = end_time - start_time
    print(f"[{end_time.strftime('%Y-%m-%d %H:%M:%S')}] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")
    print(f"  –í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∫—É—Ä—Å–æ–≤: {course_count}")
    print(f"  –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ —Ñ–∞–π–ª–æ–≤ —Å —Ç–µ—Å—Ç–∞–º–∏: {generated_test_files_count}")
    print(f"  –ó–∞—Ç—Ä–∞—á–µ–Ω–æ –≤—Ä–µ–º–µ–Ω–∏: {duration}")

if __name__ == "__main__":
    main()
